{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 26,
   "metadata": {},
   "outputs": [],
   "source": [
    "# setup\n",
    "bucket = 'nicu-data'\n",
    "\n",
    "import boto3\n",
    "import re\n",
    "from sagemaker.amazon.amazon_estimator import get_image_uri\n",
    "from sagemaker import get_execution_role\n",
    "role = get_execution_role()\n",
    "\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "import sagemaker\n",
    "from sagemaker.predictor import csv_serializer \n",
    "from sklearn import metrics\n",
    "from sklearn.metrics import roc_auc_score\n",
    "import matplotlib.pyplot as plt  \n",
    "from sqlalchemy import create_engine\n",
    "\n",
    "s3 = boto3.client('s3') \n",
    "\n",
    "pred_data = pd.DataFrame(columns=['actual', 'predicted'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Requirement already satisfied: pymysql in /home/ec2-user/anaconda3/envs/python3/lib/python3.6/site-packages (0.9.3)\n",
      "\u001b[33mYou are using pip version 10.0.1, however version 19.1 is available.\n",
      "You should consider upgrading via the 'pip install --upgrade pip' command.\u001b[0m\n"
     ]
    }
   ],
   "source": [
    "import sys\n",
    "!{sys.executable} -m pip install pymysql"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {},
   "outputs": [],
   "source": [
    "db_engine = create_engine('mysql+pymysql://<username>:<user_password>@nicu-2019-03-05.c2lckhwrw1as.us-east-1.rds.amazonaws.com:3306/nicu')\n",
    "connection = db_engine.connect()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# query data from database\n",
    "query = (\"Select Raw.isCSGM, Raw.recording_id, Generated.* \"\n",
    "         \"FROM Accelerometer_Generated Generated \"\n",
    "         \"INNER JOIN Accelerometer_Raw Raw \"\n",
    "         \"ON Raw.id = Generated.raw_id \"\n",
    "         \"ORDER BY Raw.timestamp\")\n",
    "data = pd.read_sql(query, connection)\n",
    "data.drop(['id', 'raw_id', 'left_arm_x_calibrated', 'left_arm_y_calibrated','left_arm_z_calibrated',\n",
    "            'right_arm_x_calibrated', 'right_arm_y_calibrated','right_arm_z_calibrated',\n",
    "            'left_leg_x_calibrated', 'left_leg_y_calibrated','left_leg_z_calibrated',\n",
    "            'right_leg_x_calibrated', 'right_leg_y_calibrated','right_leg_z_calibrated'], axis=1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "metadata": {},
   "outputs": [],
   "source": [
    "recording_id_list = data.recording_id.unique()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:sagemaker:Creating training-job with name: xgboost-2019-04-26-16-53-52-035\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "2019-04-26 16:53:52 Starting - Starting the training job...\n",
      "2019-04-26 16:53:54 Starting - Launching requested ML instances......\n",
      "2019-04-26 16:55:03 Starting - Preparing the instances for training......\n",
      "2019-04-26 16:56:18 Downloading - Downloading input data...\n",
      "2019-04-26 16:56:48 Training - Training image download completed. Training in progress.\n",
      "2019-04-26 16:56:48 Uploading - Uploading generated training model\n",
      "\u001b[31mArguments: train\u001b[0m\n",
      "\u001b[31m[2019-04-26:16:56:43:INFO] Running standalone xgboost training.\u001b[0m\n",
      "\u001b[31m[2019-04-26:16:56:43:INFO] File size need to be processed in the node: 0.17mb. Available memory size in the node: 8422.18mb\u001b[0m\n",
      "\u001b[31m[2019-04-26:16:56:43:INFO] Determined delimiter of CSV input is ','\u001b[0m\n",
      "\u001b[31m[16:56:43] S3DistributionType set as FullyReplicated\u001b[0m\n",
      "\u001b[31m[16:56:43] 70x100 matrix with 7000 entries loaded from /opt/ml/input/data/train?format=csv&label_column=0&delimiter=,\u001b[0m\n",
      "\u001b[31m[2019-04-26:16:56:43:INFO] Determined delimiter of CSV input is ','\u001b[0m\n",
      "\u001b[31m[16:56:43] S3DistributionType set as FullyReplicated\u001b[0m\n",
      "\u001b[31m[16:56:43] 31x100 matrix with 3100 entries loaded from /opt/ml/input/data/validation?format=csv&label_column=0&delimiter=,\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[0]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[1]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[2]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[3]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[4]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[5]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[6]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[7]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[8]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[9]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[10]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[11]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[12]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[13]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[14]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[15]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[16]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[17]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[18]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[19]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[20]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[21]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[22]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[23]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[24]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[25]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[26]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[27]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[28]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[29]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[30]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[31]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[32]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[33]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[34]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[35]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[36]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[37]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[38]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[39]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[40]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[41]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[42]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[43]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[44]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[45]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[46]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[47]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[48]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[49]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[50]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[51]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[52]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[53]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[54]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[55]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[56]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[57]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[58]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[59]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[60]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[61]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[62]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[63]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[64]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[65]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[66]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[67]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[68]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[69]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[70]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[71]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[72]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[73]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[74]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[75]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[76]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[77]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[78]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[79]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[80]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[81]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[82]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[83]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[84]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[85]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[86]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[87]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[88]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[89]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[90]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[91]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[92]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[93]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[94]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[95]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[96]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[97]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[98]#011train-error:0#011validation-error:0\u001b[0m\n",
      "\u001b[31m[16:56:43] src/tree/updater_prune.cc:74: tree pruning end, 1 roots, 0 extra nodes, 0 pruned nodes, max_depth=0\u001b[0m\n",
      "\u001b[31m[99]#011train-error:0#011validation-error:0\u001b[0m\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "2019-04-26 16:56:55 Completed - Training job completed\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:sagemaker:Creating model with name: xgboost-2019-04-26-16-57-34-204\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Billable seconds: 38\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:sagemaker:Creating endpoint with name xgboost-2019-04-26-16-53-52-035\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "-----------"
     ]
    }
   ],
   "source": [
    "pred_data = pd.DataFrame()\n",
    "\n",
    "for recording_id in recording_id_list:\n",
    "    # hold out one baby's data for testing\n",
    "    test_data = data.loc[data['recording_id'] == recording_id]\n",
    "    test_data = test_data.drop(['recording_id'], axis=1)\n",
    "    test_data = test_data.reset_index(drop=True)\n",
    "    \n",
    "    # separate the rest of the data into training and validation\n",
    "    train_data = pd.DataFrame(columns=data.columns)\n",
    "    validation_data = pd.DataFrame(columns=data.columns)\n",
    "    \n",
    "    # we want 70% of each baby's data in training and 30% of each baby's data in validation\n",
    "    for inner_recording_id in recording_id_list:\n",
    "        # make sure we aren't using the test data\n",
    "        if recording_id != inner_recording_id:\n",
    "            innerBabyData = data.loc[data['recording_id'] == recording_id]\n",
    "            innerBabyData = innerBabyData.reset_index(drop=True)\n",
    "            train, validation = np.split(innerBabyData, [int(0.7*len(innerBabyData))])    \n",
    "            train_data = train_data.append(train)\n",
    "            validation_data = validation_data.append(validation)        \n",
    "            \n",
    "    validation_data = validation_data.drop(['recording_id'], axis=1)\n",
    "    train_data = train_data.drop(['recording_id'], axis=1)\n",
    "    \n",
    "    train_data.to_csv('train.csv', index=False, header=False)\n",
    "    validation_data.to_csv('validation.csv', index=False, header=False)\n",
    "    test_data.to_csv('test.csv', index=False, header=False)\n",
    "\n",
    "    # copy the file to S3\n",
    "    boto3.Session().resource('s3').Bucket(bucket).Object('train/train.csv').upload_file('train.csv')\n",
    "    boto3.Session().resource('s3').Bucket(bucket).Object('validation/validation.csv').upload_file('validation.csv')\n",
    "    boto3.Session().resource('s3').Bucket(bucket).Object('test/test.csv').upload_file('test.csv')\n",
    "\n",
    "    container = get_image_uri(boto3.Session().region_name, 'xgboost')\n",
    "\n",
    "    s3_input_train = sagemaker.s3_input(s3_data = 's3://{}/train'.format(bucket), content_type = 'csv')\n",
    "    s3_input_validation = sagemaker.s3_input(s3_data = 's3://{}/validation'.format(bucket), content_type = 'csv')\n",
    "\n",
    "    # train\n",
    "    sess = sagemaker.Session()\n",
    "\n",
    "    xgb = sagemaker.estimator.Estimator(container,\n",
    "                                       role,\n",
    "                                       train_instance_count=1,\n",
    "                                       train_instance_type='ml.m4.xlarge',\n",
    "                                       output_path='s3://{}/output'.format(bucket),\n",
    "                                       sagemaker_session=sess)\n",
    "    xgb.set_hyperparameters(objective='binary:logistic', \n",
    "                            eval_metric='error',\n",
    "                            alpha=1.5,\n",
    "                            eta=.05,\n",
    "                            max_depth=8,\n",
    "                            min_child_weight=3.7,\n",
    "                            num_round=100)\n",
    "\n",
    "    xgb.fit({'train': s3_input_train, 'validation': s3_input_validation})\n",
    "    \n",
    "    # evaluate model\n",
    "    xgb_predictor = xgb.deploy(initial_instance_count=1,\n",
    "                               instance_type='ml.m4.xlarge')\n",
    "\n",
    "    xgb_predictor.content_type = 'text/csv'\n",
    "    xgb_predictor.serializer = csv_serializer\n",
    "    xgb_predictor.deserializer = None\n",
    "\n",
    "    def predict(data, rows=500):\n",
    "        split_array = np.array_split(data, int(data.shape[0] / float(rows) + 1))\n",
    "        predictions = ''\n",
    "        for array in split_array:\n",
    "            predictions = ','.join([predictions, xgb_predictor.predict(array).decode('utf-8')])\n",
    "\n",
    "        return np.fromstring(predictions[1:], sep=',')\n",
    "\n",
    "    predictions = predict(test_data.as_matrix()[:, 1:])\n",
    "    \n",
    "    # concat actual data and prediction\n",
    "    predictionDF = pd.DataFrame(data=predictions)\n",
    "    addData = pd.concat([test_data['isCSGM'], predictionDF], axis=1, ignore_index=True)\n",
    "    addData = addData.rename(columns={0: \"actual\", 1: \"predicted\"})\n",
    "    \n",
    "    # add to pred_data\n",
    "    pred_data = pred_data.append(addData)\n",
    "    \n",
    "    # delete endpoint\n",
    "    sagemaker.Session().delete_endpoint(xgb_predictor.endpoint)\n",
    "    \n",
    "    print('finished: ' + recording_id)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# save pred_data to notebook\n",
    "pred_data.to_csv('pred_data.csv', index=False, header=True)\n",
    "boto3.Session().resource('s3').Bucket(bucket).Object('eval/pred_data.csv').upload_file('pred_data.csv')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "## Evaluate predictions from all models"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# confusion matrix\n",
    "pd.crosstab(index=pred_data['actual'], columns=pred_data['predicted'].round(0), rownames=['actuals'], colnames=['predictions'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# ROC-AUC Score\n",
    "print(\"Validation AUC\", roc_auc_score(list(pred_data['actual']), list(pred_data['predicted'])))\n",
    "fpr, tpr, thresholds = metrics.roc_curve(list(pred_data['actual']), list(pred_data['predicted']))\n",
    "roc_auc = metrics.auc(fpr, tpr)\n",
    "plt.figure()\n",
    "plt.plot(fpr, tpr, label='ROC curve (area = %0.2f)' % (roc_auc))\n",
    "plt.plot([0, 1], [0, 1], 'k--')\n",
    "plt.xlim([0.0, 1.0])\n",
    "plt.ylim([0.0, 1.05])\n",
    "plt.xlabel('False Positive Rate')\n",
    "plt.ylabel('True Positive Rate')\n",
    "plt.title('Receiver operating characteristic')\n",
    "plt.legend(loc=\"lower right\")\n",
    "print(plt.figure())"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "conda_python3",
   "language": "python",
   "name": "conda_python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.6.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
